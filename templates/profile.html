<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Profile</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <style>
        .profile-container {
            max-width: 600px;
            margin: auto;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
            text-align: center;
        }

        h1, h3 {
            color: #007BFF;
        }

        #medicationChart {
            display: flex;
            justify-content: center;
            align-items: center;
            max-width: 400px;
            margin: 20px auto;
            height: 300px;
        }

        #infoDisplay {
            margin-top: 20px;
            text-align: center;
            font-size: 1.1em;
            color: #343a40;
        }

        #weekPicker {
            padding: 5px;
            width: 220px;
            margin: 10px auto;
            font-size: 1em;
            border-radius: 4px;
            border: 1px solid #ced4da;
            text-align: center;
        }

        button {
            padding: 5px 10px;
            margin: 10px;
            font-size: 0.9em;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }

        .button {
            display: inline-block;
            padding: 10px 15px;
            background-color: #007BFF;
            color: white;
            border-radius: 4px;
            text-decoration: none;
        }

        .button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="profile-container">
        <h1>{{ patient.name }}'s Profile</h1>
        <p><strong>Age:</strong> {{ patient.age }}</p>
        <p><strong>Gender:</strong> {{ patient.gender }}</p>
        <p><strong>Contact:</strong> {{ patient.contact }}</p>
        <p><strong>Address:</strong> {{ patient.address }}</p>

        <h3>Select a date to view medication status:</h3>
        <input type="text" id="weekPicker" placeholder="Select a date" readonly>
        <button id="detailsButton" style="display:none;">Show Medication Details</button>

        <div id="infoDisplay"></div>

        <h3>Medication Overview:</h3>
        <div id="medicationChart">
            <canvas id="chartCanvas"></canvas>
        </div>

        <a class="button" href="/">Back to Patient List</a>
    </div>

    <!-- Include Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Initialize Flatpickr for date selection
        flatpickr("#weekPicker", {
            defaultDate: new Date(),
            dateFormat: "d-m-Y", // Set date format to match your expected format
            onChange: function(selectedDates, dateStr) {
                // Fetch medication data for the selected date
                fetch(`/patients/{{ patient._id }}/medication?date=${dateStr}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && !data.error) {
                            // Display medication overview
                            document.getElementById('infoDisplay').innerText = 
                                `Medications Taken: ${data.taken}, Not Taken: ${data.not_taken}`;
                            document.getElementById('detailsButton').style.display = 'block';
                            updateChart(data.taken, data.not_taken);
                        } else {
                            document.getElementById('infoDisplay').innerText = 'No data available for this date.';
                            document.getElementById('detailsButton').style.display = 'none';
                            updateChart(0, 0); // Clear the chart
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching medication data:', error);
                        document.getElementById('infoDisplay').innerText = 'Error retrieving data.';
                    });
            }
        });

        // Function to update the chart dynamically
        let myChart; // Declare myChart outside the function for global scope
        function updateChart(taken, skipped) {
            const ctx = document.getElementById('chartCanvas').getContext('2d');
            
            // If the chart already exists, destroy it before creating a new one
            if (myChart) {
                myChart.destroy();
            }

            // Create a new chart instance with the updated data
            myChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Taken', 'Not Taken'],
                    datasets: [{
                        data: [taken, skipped],
                        backgroundColor: ['#36A2EB', '#FF6384'],
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
